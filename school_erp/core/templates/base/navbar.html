<header class="bg-white shadow px-6 py-3 flex items-center justify-between">

    <!-- Left -->
    <div class="flex items-center space-x-4">
        <i class="ri-menu-line text-xl md:hidden"></i>
        <i class="ri-search-line text-lg text-gray-500"></i>
    </div>

    <!-- Right -->
    <div class="flex items-center space-x-5">

        <button class="bg-blue-500 text-white text-xs px-3 py-1 rounded-full">
            App Store
        </button>

        <button class="bg-purple-500 text-white text-xs px-3 py-1 rounded-full">
            Google Play
        </button>


        <div class="flex items-center space-x-2 cursor-pointer">
            <i class="ri-bank-line text-xl text-blue-500"></i>
<span id="header_institute_name"
      class="text-sm font-medium max-w-[160px] truncate text-right">
    Loading...
</span>

<!-- Notification Wrapper -->
<div class="relative">

    <!-- Bell Icon -->
    <i class="ri-notification-3-line text-xl cursor-pointer"
       onclick="toggleNotifications()"></i>

    <!-- Badge -->
    <span id="notifCount"
          class="hidden absolute -top-1 -right-1 bg-red-500 text-white text-xs
                 w-5 h-5 flex items-center justify-center rounded-full">
        0
    </span>

    <!-- Dropdown -->
    <div id="notifDropdown"
         class="hidden absolute right-0 mt-3 w-80 bg-white shadow-lg rounded-lg z-50">

        <div class="p-3 border-b font-semibold">Notifications</div>

        <div id="notifList" class="max-h-64 overflow-y-auto">
            <p class="p-3 text-sm text-gray-500">Loading...</p>
        </div>

        <a href="/notifications/"
           class="block text-center text-blue-500 text-sm py-2 border-t">
            View all
        </a>
    </div>
</div>

</div>

    </div>
</header>
<script>
async function loadInstituteNameInHeader() {
    const token = window.ACCESS_TOKEN;
    if (!token) return;

    // 1Ô∏è‚É£ Get logged-in user
    const userRes = await fetch("https://erp.backend.smartbus360.com/auth/me", {
        headers: {
            Authorization: "Bearer " + token
        }
    });

    if (!userRes.ok) return;
    const user = await userRes.json();

    if (!user.institute_id) return;

    // 2Ô∏è‚É£ Get institute details
    const instRes = await fetch(
        `https://erp.backend.smartbus360.com/institutes/${user.institute_id}`,
        {
            headers: {
                Authorization: "Bearer " + token
            }
        }
    );

    if (!instRes.ok) return;
    const institute = await instRes.json();

    // 3Ô∏è‚É£ Update header
    const el = document.getElementById("header_institute_name");
    if (el) {
        el.innerText = institute.name || "Institute";
    }
}

// üöÄ Auto-load
document.addEventListener("DOMContentLoaded", loadInstituteNameInHeader);
</script>

<script>
function toggleNotifications() {
    const dropdown = document.getElementById("notifDropdown");
    dropdown.classList.toggle("hidden");

    // Reload when opened
    if (!dropdown.classList.contains("hidden")) {
        loadNotifications();
    }
}

async function loadNotifications() {
    const token = window.ACCESS_TOKEN;
    if (!token) return;

    const res = await fetch("https://erp.backend.smartbus360.com/notifications/unread", {
        headers: {
            Authorization: "Bearer " + token
        }
    });

    if (!res.ok) {
        console.error("Notifications API failed");
        return;
    }

    const data = await res.json();

    const badge = document.getElementById("notifCount");
    const list = document.getElementById("notifList");

    // Badge
    if (data.length > 0) {
        badge.innerText = data.length;
        badge.classList.remove("hidden");
    } else {
        badge.classList.add("hidden");
    }

    // List
    list.innerHTML = "";

    if (data.length === 0) {
        list.innerHTML = `
            <p class="p-3 text-sm text-gray-500">
                No new notifications
            </p>`;
        return;
    }

    data.forEach(n => {
        list.innerHTML += `
            <div class="p-3 border-b text-sm">
                <p class="font-medium">${n.title}</p>
                <p class="text-gray-500">${n.message}</p>
            </div>
        `;
    });
}

document.addEventListener("DOMContentLoaded", loadNotifications);
</script>
