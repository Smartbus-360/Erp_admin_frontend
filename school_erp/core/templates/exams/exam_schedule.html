{% extends "base/layout.html" %}
{% block content %}

<h1 class="text-xl font-semibold mb-6">Exam Schedule</h1>

<div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
    <select id="class_id" class="form-control"></select>
    <select id="section_id" class="form-control"></select>
    <select id="subject_id" class="form-control"></select>
        <select id="teacher_id" class="form-control"></select>
    <input type="date" id="exam_date" class="form-control">
</div>

<button id="addSchedule" class="bg-green-600 text-white px-4 py-2 rounded">
    Add Schedule
</button>

<table class="mt-6 w-full border">
    <thead>
        <tr class="bg-gray-100">
            <th class="p-2">Class</th>
            <th>Section</th>
            <th>Subject</th>
            <th>Date</th>
        </tr>
    </thead>
    <tbody id="scheduleTable"></tbody>
</table>

<script>
const examId = "{{ exam_id }}";

// üîê use token already exposed by layout.html
const headers = {
    "Authorization": "Bearer " + window.ACCESS_TOKEN,
    "Content-Type": "application/json"
};

const classSelect   = document.getElementById("class_id");
const sectionSelect = document.getElementById("section_id");
const subjectSelect = document.getElementById("subject_id");
const teacherSelect = document.getElementById("teacher_id");

// ================= LOAD CLASSES =================
async function loadClasses() {
    const res = await fetch(
        "https://erp.backend.smartbus360.com/classes/",
        { headers }
    );

    const classes = await res.json();

    classSelect.innerHTML = `<option value="">Select Class</option>`;
    classes.forEach(c => {
        classSelect.innerHTML += `<option value="${c.id}">${c.name}</option>`;
    });
}

// ================= LOAD SECTIONS (CLASS DEPENDENT) =================
async function loadSections(classId) {
    sectionSelect.innerHTML = `<option value="">Loading...</option>`;

    const res = await fetch(
        `https://erp.backend.smartbus360.com/sections/by-class/${classId}`,
        { headers }
    );

    const sections = await res.json();

    sectionSelect.innerHTML = `<option value="">Select Section</option>`;
    sections.forEach(s => {
        sectionSelect.innerHTML += `<option value="${s.id}">${s.name}</option>`;
    });
}

// ================= LOAD SUBJECTS =================
async function loadSubjects() {
    const res = await fetch(
        "https://erp.backend.smartbus360.com/subjects/",
        { headers }
    );

    const subjects = await res.json();

    subjectSelect.innerHTML = `<option value="">Select Subject</option>`;
    subjects.forEach(s => {
        subjectSelect.innerHTML += `<option value="${s.id}">${s.name}</option>`;
    });
}
// ================= LOAD TEACHERS =================
async function loadTeachers() {
    const res = await fetch(
        "https://erp.backend.smartbus360.com/employees/?role=Teacher",
        { headers }
    );

    const employees = await res.json();

    teacherSelect.innerHTML = `<option value="">Select Teacher</option>`;

    employees.forEach(emp => {
        teacherSelect.innerHTML +=
            `<option value="${emp.id}">${emp.name}</option>`;
    });
}

// ================= EVENT LISTENERS =================
classSelect.addEventListener("change", async () => {
    if (classSelect.value) {
        await loadSections(classSelect.value);
        loadSchedule();
    }
});

sectionSelect.addEventListener("change", () => {
    loadSchedule();
});


// ================= ADD SCHEDULE =================
document.getElementById("addSchedule").onclick = async () => {
    const res = await fetch(
        `https://erp.backend.smartbus360.com/exams/${examId}/schedule`,
        {
            method: "POST",
            headers,
            body: JSON.stringify({
                class_id: classSelect.value,
                section_id: sectionSelect.value,
                schedules: [{
                    subject_id: subjectSelect.value,
                    teacher_id: teacherSelect.value,
                    exam_date: exam_date.value
                }]
            })
        }
    );

    if (!res.ok) {
        alert("Failed to add schedule");
        return;
    }

    alert("Schedule added successfully");
    loadSchedule();   
};

// ================= INIT =================
loadClasses();
loadSubjects();
loadTeachers();
</script>
<script>
// ================= LOAD SCHEDULE =================
async function loadSchedule() {
    if (!classSelect.value || !sectionSelect.value) return;

    const res = await fetch(
        `https://erp.backend.smartbus360.com/exams/${examId}/schedule?class_id=${classSelect.value}&section_id=${sectionSelect.value}`,
        { headers }
    );

    const schedules = await res.json();

    const tbody = document.getElementById("scheduleTable");
    tbody.innerHTML = "";

    if (schedules.length === 0) {
        tbody.innerHTML = `
            <tr>
                <td colspan="4" class="text-center p-4 text-gray-500">
                    No schedule added yet
                </td>
            </tr>`;
        return;
    }

    schedules.forEach(item => {
        tbody.innerHTML += `
            <tr class="border-t">
                <td class="p-2">${classSelect.options[classSelect.selectedIndex].text}</td>
                <td>${sectionSelect.options[sectionSelect.selectedIndex].text}</td>
                <td>${item.subject_id}</td>
                <td>${item.exam_date}</td>
            </tr>
        `;
    });
}
</script>



{% endblock %}
